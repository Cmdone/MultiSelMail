$.fn.multiSelMail=function(s){function l(s,l){return o.hideBox(),e(s)?p.indexOf(s)==-1||c.single?(c.single?p=s:l>=0&&l<p.length?p.splice(l,0,s):p.push(s),void i()):(c.confirmFailRep(s),!1):(c.confirmFailFun(s),c.single&&o.inp.val(""),!1)}function t(s,l){c.single?p="":(void 0==l&&(l=p.indexOf(s)),l>=0&&l<p.length&&p.splice(l,1)),i()}function i(){if(c.single)o.inp.val(p);else{o.labels.html("");for(var s=0,l=p.length;s<l;s++){var t=$("<span>").addClass("selMailItem").addClass(c.style.labelItem.class).css(c.style.labelItem.css).html(p[s]);o.labels.append(t).append("\n")}}}function e(s){if(c.confirm){if("function"==(typeof c.confirmFunc).toLowerCase())return c.confirmFunc(s);var l=/^(\w-*\.*)+@(\w-?)+(\.\w{2,})+$/;return!!l.test(s)}return!0}function n(s){if(o.list.html(""),d=[],0!=s.length){for(var l=s.split("@")[0],t=0,i=c.mailList.length;t<i;t++){var n=l+c.mailList[t];if(0==n.indexOf(s)){d.push(t);var a=$("<li>").attr("data-mail",n).addClass("selMailOne").addClass(c.style.listItem.class).css(c.style.listItem.css);r==t&&a.addClass("ready "+c.style.listItemReady.class).css(c.style.listItemReady.css);var p=$("<span>").addClass("selMailHint").addClass(c.style.listItemHint.class).css(c.style.listItemHint.css);a.append(p.html(s)).append(n.substr(s.length)),o.list.append(a)}}if(0==d.length){var a=$("<li>").addClass("selMailOne").addClass(c.style.listItem.class).css(c.style.listItem.css);a.addClass("ready "+c.style.listItemReady.class).css(c.style.listItemReady.css);var p=$("<span>").addClass("selMailHint").addClass(c.style.listItemHint.class).css(c.style.listItemHint.css);e(s)?(a.attr("data-mail",s),a.append(p.html(s))):a.append(p.html(c.confirmFailStr)),o.list.append(a)}}}function a(s){this.container=s.addClass("selMailContainer"),""!=c.labelConId&&1==$("#"+c.labelConId).length?this.labels=$("#"+c.labelConId):this.labels=$("<div>").addClass("selMailLabel"+c.style.label.class).css(c.style.label.css),this.list=$("<ul>").addClass("selMailBox "+c.style.list.class).css(c.style.list.css),this.inp=$("<input>").attr("type","text").addClass("selMailInput "+c.style.input.class).css(c.style.input.css),this.container.html(""),""!=c.labelConId&&1==$("#"+c.labelConId).length||this.container.append(this.labels),this.container.append(this.list).append(this.inp)}var c={mailList:["@qq.com","@gmail.com","@126.com","@163.com","@sina.com"],single:!1,style:{input:{class:"",css:{}},list:{class:"",css:{}},listItem:{class:"",css:{}},listItemReady:{class:"",css:{}},listItemHint:{class:"",css:{}},label:{class:"",css:{}},labelItem:{class:"",css:{}}},labelConId:"",confirm:!0,confirmFunc:void 0,confirmFailStr:"当前邮箱格式错误",confirmFailFun:function(s){alert(s+"邮箱格式错误")},confirmFailRep:function(s){alert(s+"邮箱已选择")},cancelSpace:!1,cancelEnter:!1,cancelEsc:!1,cancelArrow:!1,clickLabelFunc:void 0};$.extend(c,s);var o=new a(this),r=-1,d=[],p=c.single?"":[];return o.inp.on("focus input",function(){o.showBox()}),o.inp.on("click",function(){return!1}),o.list.on("click",function(){return!1}),$(document).on("click",function(){o.hideBox()}),o.inp.on("keyup",function(s){if(c.cancelSpace||32!=s.keyCode)if(c.cancelEnter||13!=s.keyCode)c.cancelEsc||27!=s.keyCode?n($(this).val()):o.hideBox();else{var t=o.list.find("li.selMailOne.ready");l(1==t.length?t.attr("data-mail"):$(this).val().trim())}else{var t=o.list.find("li.selMailOne.ready");l(1==t.length?t.attr("data-mail"):$(this).val().trim())}}),o.list.on("mouseover","li.selMailOne",function(){o.list.find("li.selMailOne").removeClass("ready"),$(this).addClass("ready");var s=$(this).attr("data-mail");void 0!=s&&(r=c.mailList.indexOf("@"+s.split("@")[1]))}),o.inp.on("keydown",function(s){if(0!=d.length&&!c.cancelArrow)if(40==s.keyCode){for(r++;d.indexOf(r)==-1&&r<c.mailList.length;)r++;r=r>=c.mailList.length?d[0]:r,s.preventDefault(),n($(this).val())}else if(38==s.keyCode){for(r--;d.indexOf(r)==-1&&r>=0;)r--;r=r<0?d[d.length-1]:r,s.preventDefault(),n($(this).val())}}),o.list.on("click","li.selMailOne.ready",function(){l($(this).attr("data-mail"))}),o.labels.on("click","span.selMailItem",function(){"function"==(typeof c.clickLabelFunc).toLowerCase()?c.clickLabelFunc($(this).html()):t($(this).html())}),a.prototype.showBox=function(){this.list.css("display","block")},a.prototype.hideBox=function(){this.list.css("display","none").html(""),c.single||this.inp.val(""),r=-1},a.prototype.getMails=function(){return p},a.prototype.setMail=function(s){c.single&&l(s)},a.prototype.clrMail=function(){c.single&&t()},a.prototype.addMail=function(s,t){l(s.toString(),parseInt(t))},a.prototype.delMail=function(s,l){c.single?t():l?t("",parseInt(s)):t(s.toString())},a.prototype.spliceMail=function(s,i){if(!c.single){for(var e=0;e<i;e++)t("",parseInt(s));if(arguments.length>2)for(var e=arguments.length-1;e>=2;e--)l(arguments[e].toString(),parseInt(s))}},a.prototype.editMail=function(s,l,t){c.single||(t||(s=p.indexOf(s)),s=parseInt(s),s>=0&&s<p.length&&this.spliceMail(s,1,l))},o};