$.fn.multiSelMail=function(s){function l(s,l){return c(),i(s)?m.indexOf(s)==-1||r.single?(r.single?m=s:l>=0&&l<m.length?m.splice(l,0,s):m.push(s),void e()):(r.confirmFailRep(s),!1):(r.confirmFailFun(s),r.single&&d.inp.val(""),!1)}function t(s,l){r.single?m="":(void 0==l&&(l=m.indexOf(s)),l>=0&&l<m.length&&m.splice(l,1)),e()}function e(){if(r.single)d.inp.val(m);else{d.labels.html("");for(var s=0,l=m.length;s<l;s++){var t=$("<span>").addClass("selMailItem").addClass(r.style.labelItem.class).css(r.style.labelItem.css).html(m[s]);d.labels.append(t).append("\n")}}}function i(s){if(r.confirm){if("function"==(typeof r.confirmFunc).toLowerCase())return r.confirmFunc(s);var l=/^(\w-*\.*)+@(\w-?)+(\.\w{2,})+$/;return!!l.test(s)}return!0}function n(s){if(d.list.html(""),f=[],0!=s.length){for(var l=s.split("@")[0],t=0,e=r.mailList.length;t<e;t++){var n=l+r.mailList[t];if(0==n.indexOf(s)){f.push(t);var a=$("<li>").attr("data-mail",n).addClass("selMailOne").addClass(r.style.listItem.class).css(r.style.listItem.css);p==t&&a.addClass("ready "+r.style.listItemReady.class).css(r.style.listItemReady.css);var c=$("<span>").addClass("selMailHint").addClass(r.style.listItemHint.class).css(r.style.listItemHint.css);a.append(c.html(s)).append(n.substr(s.length)),d.list.append(a)}}if(0==f.length){var a=$("<li>").addClass("selMailOne").addClass(r.style.listItem.class).css(r.style.listItem.css);a.addClass("ready "+r.style.listItemReady.class).css(r.style.listItemReady.css);var c=$("<span>").addClass("selMailHint").addClass(r.style.listItemHint.class).css(r.style.listItemHint.css);i(s)?(a.attr("data-mail",s),a.append(c.html(s))):a.append(c.html(r.confirmFailStr)),d.list.append(a)}}}function a(){d.list.css("display","block")}function c(){d.list.css("display","none").html(""),r.single||d.inp.val(""),p=-1}function o(s){this.container=s.addClass("selMailContainer"),""!=r.labelConId&&1==$("#"+r.labelConId).length?this.labels=$("#"+r.labelConId):this.labels=$("<div>").addClass("selMailLabel "+r.style.label.class).css(r.style.label.css),this.list=$("<ul>").addClass("selMailBox "+r.style.list.class).css(r.style.list.css),this.inp=$("<input>").attr("type","text").addClass("selMailInput "+r.style.input.class).css(r.style.input.css),this.container.html(""),""!=r.labelConId&&1==$("#"+r.labelConId).length||this.container.append(this.labels),this.container.append(this.list).append(this.inp)}var r={mailList:["@qq.com","@gmail.com","@126.com","@163.com","@sina.com"],single:!1,style:{input:{class:"",css:{}},list:{class:"",css:{}},listItem:{class:"",css:{}},listItemReady:{class:"",css:{}},listItemHint:{class:"",css:{}},label:{class:"",css:{}},labelItem:{class:"",css:{}}},labelConId:"",confirm:!0,confirmFunc:void 0,confirmFailStr:"当前邮箱格式错误",confirmFailFun:function(s){alert(s+"邮箱格式错误")},confirmFailRep:function(s){alert(s+"邮箱已选择")},cancelSpace:!1,cancelEnter:!1,cancelEsc:!1,cancelArrow:!1,clickLabelFunc:void 0};$.extend(!0,r,s);var d=new o(this),p=-1,f=[],m=r.single?"":[];return d.inp.on("focus input",function(){a()}),d.inp.on("click",function(){return!1}),d.list.on("click",function(){return!1}),$(document).on("click",function(){c()}),d.inp.on("keyup",function(s){if(r.cancelSpace||32!=s.keyCode)if(r.cancelEnter||13!=s.keyCode)r.cancelEsc||27!=s.keyCode?n($(this).val()):c();else{var t=d.list.find("li.selMailOne.ready");l(1==t.length?t.attr("data-mail"):$(this).val().trim())}else{var t=d.list.find("li.selMailOne.ready");l(1==t.length?t.attr("data-mail"):$(this).val().trim())}}),d.list.on("mouseover","li.selMailOne",function(){d.list.find("li.selMailOne").removeClass("ready").removeClass(r.style.listItemReady.class).removeAttr("style"),$(this).addClass("ready "+r.style.listItemReady.class).css(r.style.listItemReady.css);var s=$(this).attr("data-mail");void 0!=s&&(p=r.mailList.indexOf("@"+s.split("@")[1]))}),d.inp.on("keydown",function(s){if(0!=f.length&&!r.cancelArrow)if(40==s.keyCode){for(p++;f.indexOf(p)==-1&&p<r.mailList.length;)p++;p=p>=r.mailList.length?f[0]:p,s.preventDefault(),n($(this).val())}else if(38==s.keyCode){for(p--;f.indexOf(p)==-1&&p>=0;)p--;p=p<0?f[f.length-1]:p,s.preventDefault(),n($(this).val())}}),d.list.on("click","li.selMailOne.ready",function(){l($(this).attr("data-mail"))}),d.labels.on("click","span.selMailItem",function(){"function"==(typeof r.clickLabelFunc).toLowerCase()?r.clickLabelFunc($(this).html()):t($(this).html())}),o.prototype.getMails=function(){return m},o.prototype.setMail=function(s){r.single&&l(s)},o.prototype.clrMail=function(){r.single&&t()},o.prototype.addMail=function(s,t){l(s.toString(),parseInt(t))},o.prototype.delMail=function(s,l){r.single?t():l?t("",parseInt(s)):t(s.toString())},o.prototype.spliceMail=function(s,e){if(!r.single){for(var i=0;i<e;i++)t("",parseInt(s));if(arguments.length>2)for(var i=arguments.length-1;i>=2;i--)l(arguments[i].toString(),parseInt(s))}},o.prototype.editMail=function(s,l,t){r.single||(t||(s=m.indexOf(s)),s=parseInt(s),s>=0&&s<m.length&&(i(l)?m.indexOf(l)!=-1?r.confirmFailRep(l):this.spliceMail(s,1,l):r.confirmFailFun(l)))},d};